(()=>{"use strict";class e{constructor(){this.agreeElement=null,this.processElement=null,this.fields=[{name:"name",id:"name",element:null,regex:/^[А-Я][а-я]+\s*$/,valid:!1},{name:"lastName",id:"last-name",element:null,regex:/^[А-Я][а-я]+\s*$/,valid:!1},{name:"email",id:"email",element:null,regex:/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/,valid:!1}];const e=this;this.fields.forEach((t=>{t.element=document.getElementById(t.id),t.element.onchange=function(){e.validateField.call(e,t,this)}})),this.processElement=document.getElementById("process"),this.processElement.onclick=function(){e.processForm()},this.agreeElement=document.getElementById("agree"),this.agreeElement.onchange=function(){e.validateForm()}}validateField(e,t){t.value&&t.value.match(e.regex)?(t.parentNode.removeAttribute("style"),e.valid=!0):(t.parentNode.style.borderColor="red",e.valid=!1),this.validateForm()}validateForm(){const e=this.fields.every((e=>e.valid)),t=this.agreeElement.checked&&e;return t?this.processElement.removeAttribute("disabled"):this.processElement.setAttribute("disabled","disabled"),t}processForm(){if(this.validateForm()){let e="";this.fields.forEach((t=>{e+=(e?"&":"?")+t.name+"="+t.element.value})),location.href="#/choice"+e}}}class t{static getQueryParams(){const e=document.location.hash.split("+").join(" ");let t,s={},n=/[?&]([^=]+)=([^&]*)/g;for(;t=n.exec(e);)s[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return s}static checkUserData(e){e.name&&e.lastName&&e.email||(location.href="#/")}}class s{constructor(){this.quizzes=[],this.routeParams=t.getQueryParams(),t.checkUserData(this.routeParams);const e=new XMLHttpRequest;if(e.open("GET","https://testologia.ru/get-quizzes",!1),e.send(),200===e.status&&e.responseText){try{this.quizzes=JSON.parse(e.responseText)}catch(e){location.href="#/"}this.processQuizzes()}else location.href="#/"}processQuizzes(){const e=document.getElementById("choice-options");this.quizzes&&this.quizzes.length>0&&this.quizzes.forEach((t=>{const s=this,n=document.createElement("div");n.className="choice-option",n.setAttribute("data-id",t.id),n.onclick=function(){s.chooseQuiz(this)};const i=document.createElement("div");i.className="choice-option-text",i.innerText=t.name;const o=document.createElement("div");o.className="choice-option-arrow";const a=document.createElement("img");a.setAttribute("src","static/images/arrow.png"),a.setAttribute("alt","Arrow"),o.appendChild(a),n.appendChild(i),n.appendChild(o),e.appendChild(n)}))}chooseQuiz(e){const t=e.getAttribute("data-id");t&&(location.href="#/test?name="+this.routeParams.name+"&lastName="+this.routeParams.lastName+"&email="+this.routeParams.email+"&id="+t)}}class n{constructor(){this.showAnswersButtonElement=null,this.routeParams=t.getQueryParams();const{score:e,total:s,id:n,name:i,lastName:o,email:a,chosenAnswerIds:r}=this.routeParams;document.getElementById("resultScore").innerText=`${e}/${s}`,this.showAnswersButtonElement=document.getElementById("show"),this.showAnswersButtonElement.onclick=()=>{this.showAnswers(n,e,s,r,i,o,a)}}showAnswers(e,t,s,n,i,o,a){console.log(this.routeParams),location.href=`#/showAnswers?id=${e}&score=${t}&total=${s}&answers=${n}&name=${i}&lastName=${o}&email=${a}`}}class i{constructor(){this.quiz=null,this.chosenAnswerIds=[],this.correctAnswerIds=[],this.routeParams=t.getQueryParams();const{score:e,total:s,id:n,name:i,lastName:o,email:a,chosenAnswerIds:r}=this.routeParams;this.loadQuiz(n,i,o,a),this.loadCorrectAnswers(n),this.showResults(),document.getElementById("made-by").innerHTML=`Тест выполнил <span>${i} ${o}, ${a}</span>`,this.showAnswersButtonElement=document.getElementById("show"),this.showAnswersButtonElement.onclick=()=>{location.href=`#/result?id=${n}&score=${e}&total=${s}&answers=${r}&name=${i}&lastName=${o}&email=${a}`}}loadQuiz(e,t,s,n){const i=new XMLHttpRequest;if(i.open("GET",`https://testologia.ru/get-quiz?id=${e}`,!1),i.send(),200===i.status&&i.responseText)try{this.quiz=JSON.parse(i.responseText),document.getElementById("pre-title").innerText=this.quiz.name,document.getElementById("made-by").innerHTML=`Тест выполнил <span>${t} ${s}, ${n}</span>`,this.chosenAnswerIds=(this.routeParams.answers||"").split(",").map((e=>parseInt(e,10)))}catch(e){console.log("Не получилось получить данные из теста: ",e)}else console.log("Не получилось загрузить тест:",i.status,i.statusText)}loadCorrectAnswers(e){const t=new XMLHttpRequest;if(t.open("GET",`https://testologia.ru/get-quiz-right?id=${e}`,!1),t.send(),200===t.status&&t.responseText)try{this.correctAnswerIds=JSON.parse(t.responseText)}catch(e){console.log("Не получилось получить правельные ответы:",e)}else console.log("Не получилось загрузить ответы:",t.status,t.statusText)}showResults(){const e=document.querySelector(".questions");e.innerHTML="",this.quiz.questions.forEach(((t,s)=>{const n=document.createElement("div");n.classList.add("question");const i=document.createElement("div");i.classList.add("question-title"),i.innerHTML=`<span>Вопрос ${s+1}:</span> ${t.question}`,n.appendChild(i);const o=document.createElement("div");o.classList.add("test-question-options"),t.answers.forEach((e=>{const s=document.createElement("div");s.className="question-option";const n=`answer-${e.id}`,i=document.createElement("input");i.className="test-question-option",i.setAttribute("id",n),i.setAttribute("type","radio"),i.setAttribute("name",`question-${t.id}`),i.setAttribute("value",e.id),i.setAttribute("disabled","disabled"),i.checked=this.chosenAnswerIds.includes(e.id);const a=document.createElement("label");a.setAttribute("for",n),a.innerText=e.answer,s.appendChild(i),s.appendChild(a);const r=this.chosenAnswerIds.includes(e.id),l=this.correctAnswerIds.includes(e.id);r&&s.classList.add("chosen"),l?s.classList.add(r?"correct":"correct-not-chosen"):r&&s.classList.add("incorrect"),o.appendChild(s)})),n.appendChild(o),e.appendChild(n)}))}}class o{constructor(){if(this.quiz=null,this.questionTitleElement=null,this.optionsElement=null,this.nextButtonElement=null,this.prevButtonElement=null,this.passButtonElement=null,this.progressBarElement=null,this.currentQuestionIndex=1,this.userResult=[],this.routeParams=t.getQueryParams(),t.checkUserData(this.routeParams),this.routeParams.id){const e=new XMLHttpRequest;if(e.open("GET","https://testologia.ru/get-quiz?id="+this.routeParams.id,!1),e.send(),200===e.status&&e.responseText){try{this.quiz=JSON.parse(e.responseText)}catch(e){location.href="#/"}this.startQuiz()}else location.href="#/"}else location.href="#/"}startQuiz(){this.progressBarElement=document.getElementById("progress-bar"),this.questionTitleElement=document.getElementById("title"),this.optionsElement=document.getElementById("options"),this.nextButtonElement=document.getElementById("next"),this.nextButtonElement.onclick=this.move.bind(this,"next"),this.passButtonElement=document.getElementById("pass"),this.passButtonElement.onclick=this.move.bind(this,"pass"),document.getElementById("pre-title").innerText=this.quiz.name,this.prevButtonElement=document.getElementById("prev"),this.prevButtonElement.onclick=this.move.bind(this,"prev"),this.prepareProgressBar(),this.showQuestion();const e=document.getElementById("timer");let t=59;const s=setInterval(function(){t--,e.innerText=t,0===t&&(clearInterval(s),this.complete())}.bind(this),1e3)}prepareProgressBar(){for(let e=0;e<this.quiz.questions.length;e++){const t=document.createElement("div");t.className="test-progress-bar-item "+(0===e?"active":"");const s=document.createElement("div");s.className="test-progress-bar-item-circle";const n=document.createElement("div");n.className="test-progress-bar-item-text",n.innerText="Вопрос "+(e+1),t.appendChild(s),t.appendChild(n),this.progressBarElement.appendChild(t)}}showQuestion(){const e=this.quiz.questions[this.currentQuestionIndex-1];this.questionTitleElement.innerHTML="<span>Вопрос"+this.currentQuestionIndex+" :</span> "+e.question,this.optionsElement.innerHTML="";const t=this,s=this.userResult.find((t=>t.questionId===e.id));e.answers.forEach((e=>{const n=document.createElement("div");n.className="test-question-option";const i="answer-"+e.id,o=document.createElement("input");o.className="option-answer",o.setAttribute("id",i),o.setAttribute("type","radio"),o.setAttribute("name","answer"),o.setAttribute("value",e.id),s&&s.chosenAnswerId===e.id&&o.setAttribute("checked","checked"),o.onchange=function(){t.chooseAnswer()};const a=document.createElement("label");a.setAttribute("for",i),a.innerText=e.answer,n.appendChild(o),n.appendChild(a),this.optionsElement.appendChild(n)})),s&&s.chosenAnswerId?(this.nextButtonElement.removeAttribute("disabled"),this.passButtonElement.classList.add("no-pointer"),this.passButtonElement.onclick=null):(this.nextButtonElement.setAttribute("disabled","disabled"),this.passButtonElement.classList.remove("no-pointer"),this.passButtonElement.onclick=this.move.bind(this,"pass")),this.currentQuestionIndex===this.quiz.questions.length?this.nextButtonElement.innerText="Завершить":this.nextButtonElement.innerText="Далее",this.currentQuestionIndex>1?this.prevButtonElement.removeAttribute("disabled"):this.prevButtonElement.setAttribute("disabled","disabled")}chooseAnswer(){this.nextButtonElement.removeAttribute("disabled"),this.passButtonElement.classList.add("no-pointer"),this.passButtonElement.onclick=null}move(e){const t=this.quiz.questions[this.currentQuestionIndex-1],s=Array.from(document.getElementsByClassName("option-answer")).find((e=>e.checked));let n=null;s&&s.value&&(n=Number(s.value));const i=this.userResult.find((e=>e.questionId===t.id));i?i.chooseAnswerId=n:this.userResult.push({questionId:t.id,chosenAnswerId:n}),"next"===e||"pass"===e?this.currentQuestionIndex++:this.currentQuestionIndex--,this.currentQuestionIndex>this.quiz.questions.length?this.complete():(Array.from(this.progressBarElement.children).forEach(((e,t)=>{const s=t+1;e.classList.remove("complete"),e.classList.remove("active"),s===this.currentQuestionIndex?e.classList.add("active"):s<this.currentQuestionIndex&&e.classList.add("complete")})),this.showQuestion())}complete(){const e=new XMLHttpRequest;if(e.open("POST","https://testologia.ru/pass-quiz?id="+this.routeParams.id,!1),e.setRequestHeader("Content-Type","application/json;charset=UTF-8"),e.send(JSON.stringify({name:this.routeParams.name,lastName:this.routeParams.lastName,email:this.routeParams.email,results:this.userResult})),200===e.status&&e.responseText){let t=null;try{t=JSON.parse(e.responseText)}catch(e){location.href="#/"}if(t){const e=this.userResult.map((e=>e.chosenAnswerId)).join(",");location.href="#/result?id="+this.routeParams.id+"&score="+t.score+"&total="+t.total+"&answers="+e+"&name="+this.routeParams.name+"&lastName="+this.routeParams.lastName+"&email="+this.routeParams.email}}else location.href="#/"}}class a{constructor(){this.routes=[{route:"#/",title:"Главная",template:"templates/index.html",styles:"css/index.css",load:()=>{}},{route:"#/form",title:"Регистрация",template:"templates/form.html",styles:"css/form.css",load:()=>{new e}},{route:"#/choice",title:"Выбор теста",template:"templates/choice.html",styles:"css/choice.css",load:()=>{new s}},{route:"#/test",title:"Прохождение теста",template:"templates/test.html",styles:"css/test.css",load:()=>{new o}},{route:"#/result",title:"Результат теста",template:"templates/result.html",styles:"css/result.css",load:()=>{new n}},{route:"#/showAnswers",title:"Ответы теста",template:"templates/showAnswers.html",styles:"css/showAnswers.css",load:()=>{new i}}]}async openRoute(){const e=this.routes.find((e=>e.route===window.location.hash.split("?")[0]));e?(document.getElementById("content").innerHTML=await fetch(e.template).then((e=>e.text())),document.getElementById("styles").setAttribute("href",e.styles),document.getElementById("page-title").innerText=e.title,e.load()):window.location.href="#/"}}new class{constructor(){this.router=new a,window.addEventListener("DOMContentLoaded",this.handleRouteChanging.bind(this)),window.addEventListener("popstate ",this.handleRouteChanging.bind(this))}handleRouteChanging(){this.router.openRoute()}}})();